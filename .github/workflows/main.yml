name: main

on:
  workflow_dispatch:
    inputs:
      codespace:
        description: 'Name of the codespace to connect to'
        required: true

jobs:
  connect-to-codespace:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - run: |
        mkdir /home/runner/.ssh
        ssh-keygen -N '' -f ~/.ssh/id_ecdsa -t ecdsa -b 521
        cat ~/.ssh/id_ecdsa >> ~/.ssh/authorized_keys
        echo Host codespace > ~/.ssh/config
        echo     HostName root@cs.${{ inputs.codespace }}.main >> ~/.ssh/config
        echo     User codespace >> ~/.ssh/config
        echo     Port 4748 >> ~/.ssh/config
        echo     ServerAliveInterval 60 >> ~/.ssh/config
        echo     StrictHostKeyChecking no >> ~/.ssh/config
        echo     UserKnownHostsFile /dev/null >> ~/.ssh/config
        echo     ProxyCommand /usr/bin/gh cs ssh -c ${{ inputs.codespace }} --stdio -- -i ~/.ssh/id_ecdsa >> ~/.ssh/config
        echo     IdentityFile ~/.ssh/id_ecdsa >> ~/.ssh/config
        scp ~/.ssh/id_ecdsa root@codespace: 
        ssh -R 4748:localhost:22 codespace perl -MPOSIX -e pause'
      env:
        GH_TOKEN: ${{ secrets.TOKEN_FOR_CODESPACES }}